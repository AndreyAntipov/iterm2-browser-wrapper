#!/usr/bin/env ruby
# encoding: utf-8

# Setup patches
lib = File.expand_path(File.dirname(__FILE__) + '/../lib')
$LOAD_PATH.unshift(lib) if File.directory?(lib) && !$LOAD_PATH.include?(lib)

require 'iterm2/viewer'

module Iterm2
  # CLI interface for view images in terminal
  module Viewer
    # Common methods
    # @param [String, #arguments] routes to files
    # @todo write tests
    class << self
      def show(arguments)
        # initialize whenever application called from iTerm2 with arguments
        return unless ENV['TERM_PROGRAM'] == 'iTerm.app' || arguments.nil?

        # catch options
        if arguments[0] =~ /^(-\w|--\w{2,}?)$/
          # @todo refactoring
          # @todo add notification â€” command not found
          version if arguments[0].to_s == '--version' || arguments[0].to_s == '-v'
        # switch to renders
        else
          # clean entire screen
          # todo: optimize (fit to enitre screen)
          print "\e[2J\e[f"

          # reveal media files
          arguments.each do |route|
            begin
              Render.new(Media.new route).reveal
            # skip incorrect routes
            rescue ArgumentError
              next
             end
          end
        end
      end

      def version
        abort VERSION
      end

    end
  end
end

# Run application with shell arguments
Iterm2::Viewer.show ARGV
